var Validation,Dynamics,MetadataBrower,RecordCounter;(function(n){var t;(function(n){"use strict";n.componentName=function(n,t){return n+"_"+t}})(t=n.Crm||(n.Crm={}))})(Dynamics||(Dynamics={})),function(n){var t;(function(n){var t;(function(n){"use strict";n.bootstrap="cc";n.logEntry="cc"})(t=n.Publishers||(n.Publishers={}))})(t=n.Crm||(n.Crm={}))}(Dynamics||(Dynamics={})),function(n){var t;(function(n){"use strict";var r=function(){function n(){}return n.Error="ERROR",n.Warning="WARNING",n.Information="INFO",n}(),t,i;n.FormNotificationTypes=r;t=function(){function n(){}return n.Browser="Web",n.Outlook="Outlook",n.Mobile="Mobile",n}();n.ClientType=t;i=function(){function n(){}return n.None="none",n.Required="required",n.Recommended="recommended",n}();n.AttributeRequiredLevels=i})(t=n.Crm||(n.Crm={}))}(Dynamics||(Dynamics={})),function(n){var t;(function(t){var i;(function(i){"use strict";function r(n){i.log=new e(n||t.Publishers.logEntry)}function o(n){i.log=new f(n||t.Publishers.logEntry)}function s(){for(var t,i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];for(console.log("Function "+arguments[0]+" called with arguments: {"),t=1;t<arguments.length;t++)console.log(arguments[t]);console.log("}")}function u(i,r,u){var e=h(),o=c(),s=l(),y=v(),p=a(),w=u.stack||u.stacktrace||"<none>",b=u.description||"<none>",k="JavaScript::"+y+","+p+","+s+":"+e+"("+o+")",d="Stack: "+w+"\nDescription: "+b,f={type:t.Data.Schema.LogEntryEntity.type(i)},g=u.type?u.type+":"+r:r,nt=r===u.message?r:(r+". "+u.message).trim();return f[t.Data.Schema.LogEntryEntity.nameField(i)]=Validation.Strings.left(g,300),f[t.Data.Schema.LogEntryEntity.messageField(i)]=Validation.Strings.left(nt,5e3),f[t.Data.Schema.LogEntryEntity.descriptionField(i)]=Validation.Strings.right(d,1048576),f[t.Data.Schema.LogEntryEntity.sourceField(i)]=Validation.Strings.left(k,500),f[t.Data.Schema.LogEntryEntity.typeField(i)]=n.Crm.Core.LogEntryType.Error,f}function h(){try{return Xrm.Page.data.entity.getEntityName()}catch(n){return i.trace&&i.log&&i.log.Warning(n),"UnknownEntity"}}function c(){try{return Xrm.Page.data.entity.getId()}catch(n){return i.trace&&i.log&&i.log.Warning(n),""}}function l(){try{return Xrm.Page.ui.getFormType().toString()}catch(n){return i.trace&&i.log&&i.log.Warning(n),""}}function a(){try{return Xrm.Utility.getGlobalContext().client.getFormFactor()}catch(n){return i.trace&&i.log&&i.log.Warning(n),-1}}function v(){try{return Xrm.Utility.getGlobalContext().client.getClient()}catch(n){return i.trace&&i.log&&i.log.Warning(n),"unknown"}}i.debug=!0;i.trace=!0;var f=function(){function n(n){this._prefix=n}return n.prototype.Error=function(n,t){i.debug;var r=u(this._prefix,n,t);console.error(r)},n.prototype.Message=function(n){console.log(n)},n.prototype.Warning=function(n){console.warn(n)},n}(),e=function(){function t(n){this._prefix=n}return t.prototype.Error=function(t,r){i.debug;var f=u(this._prefix,t,r);console.error(f);n.Crm.Data.unitOfWork.GetLogEntryRepository(this._prefix).Create(f)},t.prototype.Message=function(n){console.log(n)},t.prototype.Warning=function(n){console.warn(n)},t}();i.useLogEntryLogger=r;i.useConsoleLogger=o;i.printArguments=s;r()})(i=t.Diagnostics||(t.Diagnostics={}))})(t=n.Crm||(n.Crm={}))}(Dynamics||(Dynamics={})),function(n){"use strict";function t(n,t){if(n===undefined||n===null)throw new Error(Resources.Strings.NullArgumentMessageFormat(t));}function i(n,t){if(n===undefined||n===null)throw new Error(Resources.Strings.NullArgumentMessageFormat(t));if(!_.isString(n))throw new Error(Resources.Strings.InvalidTypeMessageFormat("string",typeof n));if(n==="")throw new Error(Resources.Strings.NullArgumentMessageFormat(t));}function r(n,t,i,r){if(t===void 0&&(t=null),i===void 0&&(i=null),r===void 0&&(r=null),!_.isNumber(n))throw new Error(Resources.Strings.InvalidTypeMessageFormat("number",typeof n));if(_.isNumber(t)&&n<t)throw new Error(Resources.Strings.OutOfRangeMessageFormat(r));if(_.isNumber(i)&&n>i)throw new Error(Resources.Strings.OutOfRangeMessageFormat(r));}n.ensureNotNullOrUndefined=t;n.ensureNotNullOrEmpty=i;n.ensureNumberInRange=r}(Validation||(Validation={})),function(n){var t;(function(t){"use strict";function i(t,i){return(n.ensureNumberInRange(i,0),t===null||t===undefined)?t:t.length<=i?t:t.substr(0,i)}function r(t,i){return(n.ensureNumberInRange(i,0),t===null||t===undefined)?t:t.length<=i?t:t.substr(t.length-i,i)}t.left=i;t.right=r})(t=n.Strings||(n.Strings={}))}(Validation||(Validation={})),function(n){var t;(function(n){var t;(function(t){"use strict";function i(){var n;if(typeof Xrm!="undefined"&&typeof Xrm.Utility!="undefined"&&typeof Xrm.Utility.getGlobalContext=="function"?n=Xrm.Utility.getGlobalContext():typeof GetGlobalContext=="function"&&(n=GetGlobalContext()),!n)throw new Error("Unable to resolve CRM Global Context.");return n}function h(){var t=i().getVersion();if(t===undefined)return n.Diagnostics.log.Warning("getContext().getVersion() is undefined"),"v9.0";if(t>="9.0")return"v9.0";if(t>="8.2")return"v8.2";if(t>="8.1")return"v8.1";if(t>="8.0")return"v8.0";throw new Error("Version not supported: {version}.".replace("{version}",t));}function u(n){return n+"id"}function f(n,t,i){if(!i)return null;var r=u(n),f={id:i[r],type:n};return t.forEach(function(n){if(n!==r){var t=i[n];t!==undefined&&(f[n]=t)}}),f}function e(n){var t={};return Object.keys(n).forEach(function(i){i!=="id"&&i!=="type"&&(t[i]=n[i])}),t}function c(t,i,r,u,e){Validation.ensureNotNullOrEmpty(t,"entityName");Validation.ensureNotNullOrEmpty(i,"entitySetName");Validation.ensureNotNullOrEmpty(r,"entityId");var o="?$select="+u.join(",");return e&&e.length&&(o+="&$expand="+e.join(",")),new Promise(function(i,e){Xrm.WebApi.retrieveRecord(t,r,o).then(function(n){i(f(t,u,n))},function(i){n.Diagnostics.log.Error(i.message+" retrieve "+t+":"+r+":"+o,{message:i.message,description:"Code: "+i.errorCode,name:"WebApiError"});e(i)})})}function l(t,i,u,e,o,s,h,c){o===void 0&&(o=null);s===void 0&&(s=null);h===void 0&&(h=null);c===void 0&&(c=1e3);Validation.ensureNotNullOrEmpty(t,"entityName");Validation.ensureNotNullOrEmpty(i,"entitySetName");var a=!o||o===r.And?" and ":" or ",l="?$select="+u.join(",")+"&$filter="+e.join(a);return s&&(l+="&$orderby="+s.join(",")),h&&(l+="&$expand="+h.join(",")),new Promise(function(i,r){Xrm.WebApi.retrieveMultipleRecords(t,l,c).then(function(n){i(n.entities.map(function(n){return f(t,u,n)}))},function(i){n.Diagnostics.log.Error(i.message+" retrieve multiple "+t+":"+l,{message:i.message,description:"Code: "+i.errorCode,name:"WebApiError"});r(i)})})}function a(t,i,r){return Validation.ensureNotNullOrEmpty(t,"entityName"),Validation.ensureNotNullOrEmpty(i,"entitySetName"),Validation.ensureNotNullOrEmpty(r,"entityId"),new Promise(function(i,u){Xrm.WebApi.deleteRecord(t,r).then(function(n){i({type:n.entityType,id:n.id,name:n.name})},function(i){n.Diagnostics.log.Error(i.message+" delete "+t,{message:i.message,description:"Code: "+i.errorCode,name:"WebApiError"});u(i)})})}function v(t,i,r,f){var o,h,s;return r===void 0&&(r=null),f===void 0&&(f=!0),Validation.ensureNotNullOrUndefined(t,"entity"),Validation.ensureNotNullOrEmpty(i,"entitySetName"),o=u(t.type),r=r||[],r.indexOf(o)<0&&r.push(o),h="?$select="+r.join(","),s=e(t),new Promise(function(i,r){Xrm.WebApi.createRecord(t.type,s).then(function(n){i({type:n.entityType,id:n.id})},function(i){f&&n.Diagnostics.log.Error(i.message+" create "+t.type,{message:i.message,description:"Code: "+i.errorCode,name:"WebApiError"});r(i)})})}function y(t,i){Validation.ensureNotNullOrUndefined(t,"entity");Validation.ensureNotNullOrEmpty(i,"entitySetName");var r=e(t);return new Promise(function(i,u){Xrm.WebApi.updateRecord(t.type,t.id,r).then(function(n){i({type:n.entityType,id:n.id})},function(i){n.Diagnostics.log.Error(i.message+" update "+t.type+":"+t.id,{message:i.message,description:"Code: "+i.errorCode,name:"WebApiError"});u(i)})})}function p(t,i,r,u){u===void 0&&(u=500);var f="?fetchXml="+encodeURIComponent(r);return new Promise(function(i,r){Xrm.WebApi.retrieveMultipleRecords(t,f,u).then(function(n){i(n)},function(i){n.Diagnostics.log.Error(i.message+" fetch "+t+":"+f,{message:i.message,description:"Code: "+i.errorCode,name:"WebApiError"});r(i)})})}function w(n){n===void 0&&(n=o);var t="?$select="+n.join(",");return new Promise(function(n,i){Xrm.WebApi.retrieveMultipleRecords("EntityDefinition",t,500).then(function(t){n(t.entities)},function(n){console.error(n);i(n)})})}function b(n,t){t===void 0&&(t=s);Validation.ensureNotNullOrEmpty(n,"metadataId");var r=i().getClientUrl(),u=r+"/api/data/"+h()+"/EntityDefinitions("+n+")/Attributes?$select="+t.join(",");return $.ajax({url:u,dataType:"json"}).then(function(n){return n.value})}function k(n,t){Validation.ensureNotNullOrEmpty(n,"metadataId");Validation.ensureNotNullOrEmpty(t,"attributeMetadataId");var r=i().getClientUrl(),u=r+"/api/data/v8.0/EntityDefinitions("+n+")/Attributes("+t+")/Microsoft.Dynamics.CRM.PicklistAttributeMetadata/OptionSet?$select=Options";return $.ajax({url:u,dataType:"json"}).then(function(n){return n?n.Options:[]})}var r,o,s;(function(n){n[n.And=1]="And";n[n.Or=2]="Or"})(r=t.FilterType||(t.FilterType={}));t.retrieve=c;t.retrieveMultiple=l;t.deleteEntity=a;t.createEntity=v;t.updateEntity=y;t.fetch=p;o=["MetadataId","DisplayName","LogicalName","ObjectTypeCode","SchemaName","EntitySetName","PrimaryIdAttribute","ExternalName"];t.entityDefinitions=w;s=["MetadataId","DisplayName","LogicalName","AttributeType","Description"];t.entityAttributesDefinition=b;t.entityAttributeOptionSetDefinition=k})(t=n.OData||(n.OData={}))})(t=n.Crm||(n.Crm={}))}(Dynamics||(Dynamics={})),function(n){var t;(function(n){"use strict";function i(n){return new t(n)}var t=function(){function n(n){this._$q=n}return n.prototype.GetEntities=function(){var n=this._$q.defer();return Dynamics.Crm.OData.entityDefinitions().then(function(t){n.resolve(t)}).catch(function(){n.reject()}),n.promise},n.prototype.GetAttributes=function(n){var t=this._$q.defer();return Dynamics.Crm.OData.entityAttributesDefinition(n.MetadataId).then(function(n){t.resolve(n)}).fail(function(){t.reject()}),t.promise},n.prototype.GetOptionSets=function(n,t){var i=this._$q.defer();return Dynamics.Crm.OData.entityAttributeOptionSetDefinition(n.MetadataId,t.MetadataId).done(function(n){i.resolve(n)}).fail(function(){i.reject()}),i.promise},n}();n.dataService="data-service";angular.module(n.dataService,[]).factory("metadataBrowser.core.dataService",["$q",i])})(t=n.Core||(n.Core={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(n){"use strict";function t(){return{controller:i,restrict:"E",scope:{currentPage:"=",pageSize:"=",total:"="},template:'<span class="pager">\n    <span ng-bind="currentPage"><\/span> of <span ng-bind="pages"><\/span>\n    <md-button ng-click="prev()">Prev<\/md-button>\n    <md-button ng-click="next()">Next<\/md-button>\n<\/span>'}}var i=function(){function n(n){this._scope=n;this._scope.$watch("total",this.updatePages.bind(this));this._scope.$watch("pageSize",this.updatePages.bind(this));this._scope.next=this.next.bind(this);this._scope.prev=this.prev.bind(this)}return n.prototype.updatePages=function(){this._scope.pageSize===0&&(this._scope.pageSize=10);this._scope.pages=Math.ceil(this._scope.total/this._scope.pageSize)},n.prototype.next=function(){this._scope.currentPage>=this._scope.pages||this._scope.currentPage++},n.prototype.prev=function(){this._scope.currentPage<=1||this._scope.currentPage--},n.$inject=["$scope"],n}();n.pager="pager";angular.module(n.pager,[]).directive(n.pager,t)})(t=n.Controllers||(n.Controllers={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(n){"use strict";function t(){angular.bootstrap(document,[n.moduleName])}window.ENTITY_SET_NAMES=window.ENTITY_SET_NAMES||JSON.stringify({entitydefinition:"EntityDefinitions"});n.moduleName="record-counter";angular.module(n.moduleName,["ngMaterial","ngMessages",MetadataBrower.Core.dataService,MetadataBrower.Controllers.pager]);angular.element(document).ready(t)})(t=n.Config||(n.Config={}))}(RecordCounter||(RecordCounter={})),function(n){var t;(function(){"use strict";function i(n,t,r,u,f,e){if(u===void 0&&(u=0),f===void 0&&(f=3),e===void 0&&(e=!0),u>=t.length)return n.resolve();var h=t.slice(u,u+f),c=h.map(function(n){return r(n)}),o=n.defer(),s=function(){i(n,t,r,u+f,f).then(function(){o.resolve()}).catch(function(n){e?o.resolve():o.reject(n)})};return n.all(c).then(function(){s()}).catch(function(n){e?s():o.reject(n)}),o.promise}function r(n,t){return n.LogicalName+","+t.value+","+(t.error||"")}var t,u=function(){function n(n,t,i,r){this._q=t;this._http=i;this._dataService=r;this.counter={};this.currentPage=1;this.data=[];this.entities=[];this.filter="";this.isBusy=!1;this.pageSize=20;this.total=0;this.operator=">=";this.compareValue=null;n.$watch("vm.currentPage",this.filterEntities.bind(this));this.refresh()}return n.prototype.refresh=function(){var n=this;this.loadEntities().then(function(){n.count().then(function(){n.updateChart()})})},n.prototype.search=function(){this.currentPage=1;this.filterEntities()},n.prototype.clear=function(){this.currentPage=1;this.filter="";this.compareValue=null;this.showEntities()},n.prototype.export=function(){var t=this,i=new Blob(["Entity Name,Record Count,Error\n"+this.data.map(function(n){return r(n,t.counter[n.LogicalName])}).join("\n")],{type:"text/csv"}),u=URL.createObjectURL(i),n=document.getElementById("download");n.href=u;n.download="record_counter.csv";n.click()},n.prototype.count=function(){var n=this;return this.isBusy=!0,i(this._q,this.data,function(t){var i={},r;return n.counter[t.LogicalName]=i,t.ExternalName?(i.error="Unable to count virtual entity",n._q.resolve()):(i.busy=!0,r=n._q.defer(),n.fetchAggregateCount(t).then(function(n){try{i.busy=!1;i.value=n.data.value[0].count}catch(t){i.error="Unable to retrieve count";console.warn(t)}r.resolve()}).catch(function(u){try{var f=u.data.error.message;f.indexOf("AggregateQueryRecordLimit")>=0?n.fetchAll(t).then(function(){i.busy=!1;r.resolve()}).catch(function(){i.busy=!1;r.resolve()}):(i.busy=!1,i.error=f,r.resolve())}catch(e){i.error="Something went wrong";console.warn(e);r.resolve()}}),r.promise)},0,10).finally(function(){n.isBusy=!1})},n.prototype.fetchAggregateCount=function(n){var t='\n<fetch aggregate="true">\n    <entity name="'+n.LogicalName+'">\n        <attribute name="'+n.PrimaryIdAttribute+'" aggregate="count" alias="count" />\n    <\/entity>\n<\/fetch>',i=Xrm.Utility.getGlobalContext().getClientUrl()+"/api/data/v9.0/"+n.EntitySetName+"?fetchXml="+encodeURIComponent(t);return this._http.get(i)},n.prototype.fetchAll=function(n){var r=this,i=this.counter[n.LogicalName],t=this._q.defer(),u=Xrm.Utility.getGlobalContext().getClientUrl()+"/api/data/v9.0/"+n.EntitySetName+"?$select="+n.PrimaryIdAttribute+"&$count=true";return this._http.get(u,{headers:{"OData-MaxVersion":"4.0","OData-Version":"4.0",Prefer:"odata.maxpagesize=5000"}}).then(function(u){var f=u.data["@odata.nextLink"],e=u.data["@odata.count"];i.value=e;f?r.fetchNext(n,i,f).then(function(){t.resolve()}):t.resolve()}).catch(function(){i.error="Unable to retrieve all records";t.resolve()}),t.promise},n.prototype.fetchNext=function(n,t,i){var u=this,r=this._q.defer();return this._http.get(i,{headers:{"OData-MaxVersion":"4.0","OData-Version":"4.0"}}).then(function(i){var f=i.data["@odata.nextLink"];f?(t.value+=i.data["@odata.count"],u.fetchNext(n,t,f).then(function(){r.resolve()})):(r.resolve(),t.value+=i.data.value.length)}).catch(function(){r.resolve()}),r.promise},n.prototype.filterEntities=function(){var i=this,n=this.filter,t=this.compareValue,r=this.data.filter(function(r){var u=!0,f;return n&&r.LogicalName.indexOf(n)<0&&(u=!1),f=i.counter[r.LogicalName]||{},t&&(!f.value||f.value<t)&&(u=!1),u});this.showEntities(r)},n.prototype.loadEntities=function(){var n=this;return this.currentPage=1,this.data=[],this.entities=[],this.filter="",this.total=0,this.isBusy=!0,this._dataService.GetEntities().then(function(t){n.data=t.sort(function(n,t){return n.LogicalName<t.LogicalName?-1:n.LogicalName>t.LogicalName?1:0});n.showEntities()}).finally(function(){n.isBusy=!1})},n.prototype.showEntities=function(n){n=n||this.data;var t=this.pageSize,i=(this.currentPage-1)*t;this.total=n.length;this.entities=n.filter(function(n,r){return r>=i&&r<i+t})},n.prototype.updateChart=function(n){var i=this;n===void 0&&(n=10);var r=this.data.sort(function(n,t){var r=(i.counter[n.LogicalName]||{}).value||0,u=(i.counter[t.LogicalName]||{}).value||0;return u-r}).filter(function(t,i){return i<n}),u=r.map(function(n){return n.LogicalName}),e=r.map(function(n){return i.counter[n.LogicalName].value||0}),f={label:"Top Entities",data:e,backgroundColor:["rgba(75, 192, 192, 0.2)","rgba(54, 162, 235, 0.2)","rgba(255, 206, 86, 0.2)","rgba(153, 102, 255, 0.2)","rgba(255, 159, 64, 0.2)","rgba(255, 99, 132, 0.2)","rgba(200, 99, 132, 0.2)","rgba(200, 199, 132, 0.2)","rgba(255, 50, 102, 0.2)","rgba(200, 99, 232, 0.2)"],borderWidth:1};t?(t.data.labels=u,t.data.datasets[0]=f,t.update()):t=new Chart("top-entities-chart",{type:"pie",data:{labels:u,datasets:[f]},options:{responsive:!1,maintainAspectRatio:!0}})},n.$inject=["$scope","$q","$http","metadataBrowser.core.dataService"],n}();angular.module(n.Config.moduleName).controller("recordCounter.ui.controllers.mainController",u)})(t=n.Controllers||(n.Controllers={}))}(RecordCounter||(RecordCounter={}));