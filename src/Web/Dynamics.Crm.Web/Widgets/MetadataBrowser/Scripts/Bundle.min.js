var Dynamics,MetadataBrower;(function(n){var t;(function(t){var i;(function(i){"use strict";function r(){var n;if(Xrm&&Xrm.Page&&Xrm.Page.context?n=Xrm.Page.context:GetGlobalContext&&(n=GetGlobalContext()),!n)throw new Error("Unable to resolve CRM Global Context.");return n}function u(){var n=r().getVersion();if(n===undefined)return console.warn("getContext().getVersion() is undefined"),"v8.0";if(n>="8.2")return"v8.2";if(n>="8.1")return"v8.1";if(n>="8.0")return"v8.0";throw new Error("Version not supported: {version}.".replace("{version}",n));}function f(n){return(n=n.toLowerCase(),n[n.length-1]==="y")?n.substr(0,n.length-1)+"ies":n+"s"}function o(n){return n+"id"}function e(n,t,i){if(!i)return null;var r=o(n),u={id:i[r],type:n,attributes:{}};return t.forEach(function(n){if(n!==r){var t=i[n];t!==undefined&&(u.attributes[n]={value:t})}}),u}function s(i,o,s,h){var l=r().getClientUrl(),c="{baseUrl}/api/data/{version}/{entitySetName}({entityId})?$select={select}".replace("{baseUrl}",l).replace("{version}",u()).replace("{entitySetName}",f(i)).replace("{entityId}",t.Core.parseIdentifier(o)).replace("{select}",s.join(","));return h&&(c+="&$expand="+h.join(",")),$.ajax({url:c,dataType:"json"}).then(function(n){return e(i,s,n)}).fail(function(t){t&&t.responseJSON&&t.responseJSON.error&&n.Crm.Diagnostics.log.Error(t.responseJSON.error.message,t.responseJSON.error.innererror||t.responseJSON.error)})}function h(t,i,o){var s=r().getClientUrl(),h="{baseUrl}/api/data/{version}/{entitySetName}?$select={select}&$filter={filter}".replace("{baseUrl}",s).replace("{version}",u()).replace("{entitySetName}",f(t)).replace("{select}",i.join(",")).replace("{filter}",o.join(","));return $.ajax({url:h,dataType:"json"}).then(function(n){var r=n.value;return r.map(function(n){return e(t,i,n)})}).fail(function(t){t&&t.responseJSON&&t.responseJSON.error&&n.Crm.Diagnostics.log.Error(t.responseJSON.error.message,t.responseJSON.error.innererror||t.responseJSON.error)})}function c(n,t){var i=r().getClientUrl(),u="{0}/api/data/v8.1/{1}({2})".replace("{0}",i).replace("{1}",f(n)).replace("{2}",t);return $.ajax({url:u,dataType:"json",type:"DELETE"})}function l(n){var t=r().getClientUrl(),i="{0}/api/data/v8.1/{1}".replace("{0}",t).replace("{1}",f(n.type)),u=JSON.stringify(n.attributes);return $.ajax({url:i,contentType:"application/json; charset=utf-8",dataType:"json",type:"POST",data:u})}function a(){var n=r().getClientUrl(),t="{baseUrl}/api/data/{version}/EntityDefinitions".replace("{baseUrl}",n).replace("{version}",u());return $.ajax({url:t,dataType:"json"}).then(function(n){return n?n.value:[]})}function v(n){var t=r().getClientUrl(),i="{baseUrl}/api/data/{version}/EntityDefinitions({metadataId})/Attributes".replace("{baseUrl}",t).replace("{version}",u()).replace("{metadataId}",n);return $.ajax({url:i,dataType:"json"}).then(function(n){return n.value})}i.retrieve=s;i.retrieveMultiple=h;i.deleteEntity=c;i.createEntity=l;i.entityDefinitions=a;i.entityAttributesDefinition=v})(i=t.OData||(t.OData={}))})(t=n.Crm||(n.Crm={}))})(Dynamics||(Dynamics={})),function(n){var t;(function(n){"use strict";n.moduleName="metadata-browser";angular.module(n.moduleName,["ui.bootstrap"])})(t=n.Config||(n.Config={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(){"use strict"})(t=n.Core||(n.Core={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(){"use strict";function i(n){return new t(n)}var t=function(){function n(n){this._$q=n}return n.prototype.GetEntities=function(){var n=this._$q.defer();return Dynamics.Crm.OData.entityDefinitions().done(function(t){n.resolve(t)}).fail(function(){n.reject()}),n.promise},n.prototype.GetAttributes=function(n){var t=this._$q.defer();return Dynamics.Crm.OData.entityAttributesDefinition(n.MetadataId).done(function(n){t.resolve(n)}).fail(function(){t.reject()}),t.promise},n}();angular.module(n.Config.moduleName).factory("metadataBrowser.core.dataService",["$q",i])})(t=n.Core||(n.Core={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(){"use strict";function i(){return new t}var t=function(){function n(){this.EntityTabs=[]}return n.prototype.AddEntityTab=function(n){var t=this.EntityTabs.filter(function(t){return t.entity.LogicalName===n.LogicalName});t.length?t[0].active=!0:this.EntityTabs.push({active:!0,entity:n,title:n.SchemaName})},n.prototype.DeleteEntityTab=function(n){_.remove(this.EntityTabs,function(t){return t.entity.LogicalName===n.entity.LogicalName})},n}();angular.module(n.Config.moduleName).factory("metadataBrowser.core.navigationService",[i])})(t=n.Core||(n.Core={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(){"use strict";var t=function(){function n(n){var t=this;t.navigationService=n}return n.$inject=["metadataBrowser.core.navigationService"],n}();angular.module(n.Config.moduleName).controller("metadataBrowser.ui.controllers.crmMetadataBrowser",t)})(t=n.Controllers||(n.Controllers={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(){"use strict";var t=function(){function n(n,t,i){this.advancedView=!1;this.currentPage=1;this.entities=[];this.entitiesToShow=[];this.filter="";this.isBusy=!1;this.pageSize=20;this.total=0;this.navigationService=t;this.dataService=i;n.$watch("vm.currentPage",this.filterEntities.bind(this));this.loadEntities()}return n.prototype.clear=function(){this.currentPage=1;this.filter="";this.showEntities()},n.prototype.exportToCsv=function(){console.warn("Not implemented")},n.prototype.filterEntities=function(){var n=this.filter,t=this.entities.filter(function(t){return t.LogicalName.indexOf(n)>=0});this.showEntities(t)},n.prototype.loadEntities=function(){var n=this;this.currentPage=1;this.entities=[];this.entitiesToShow=[];this.filter="";this.total=0;this.isBusy=!0;this.dataService.GetEntities().then(function(t){n.entities=t.sort(function(n,t){return n.SchemaName<t.SchemaName?-1:n.SchemaName>t.SchemaName?1:0});n.showEntities()}.bind(this)).finally(this.loadEntitiesCompleted.bind(this))},n.prototype.loadEntitiesCompleted=function(){this.isBusy=!1},n.prototype.showEntities=function(n){n=n||this.entities;var t=this.pageSize,i=(this.currentPage-1)*t;this.total=n.length;this.entitiesToShow=n.filter(function(n,r){return r>=i&&r<i+t})},n.prototype.openEntity=function(n){this.navigationService.AddEntityTab(n)},n.prototype.search=function(){this.currentPage=1;this.filterEntities()},n.$inject=["$scope","metadataBrowser.core.navigationService","metadataBrowser.core.dataService"],n}();angular.module(n.Config.moduleName).controller("metadataBrowser.ui.controllers.entityList",t)})(t=n.Controllers||(n.Controllers={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(){"use strict";function t(){return{controller:i,restrict:"A",scope:{entity:"="},templateUrl:"templates/entity_details.html"}}var i=function(){function n(n,t){this._dataService=t;n.vm={advancedView:!1,attributes:[],currentPage:1,entity:n.entity,entityAttributes:[],isBusy:!1,filter:"",pageSize:20,total:0};n.clear=this.clear.bind(this);n.search=this.search.bind(this);n.export=this.export.bind(this);this.vm=n.vm;this.loadEntityMetadata();n.$watch("vm.currentPage",this.filterAttributes.bind(this))}return n.prototype.clear=function(){this.vm.currentPage=1;this.vm.filter="";this.showAttributes()},n.prototype.export=function(){console.warn("Not implemented")},n.prototype.filterAttributes=function(){var n=this.vm.filter,t=this.vm.entityAttributes.filter(function(t){return t.LogicalName.indexOf(n)>=0});this.showAttributes(t)},n.prototype.loadEntityMetadata=function(){var n=this;return this.vm.isBusy=!0,this._dataService.GetAttributes(this.vm.entity).then(function(t){n.vm.entityAttributes=t.sort(function(n,t){return n.SchemaName<t.SchemaName?-1:n.SchemaName>t.SchemaName?1:0});n.showAttributes()}.bind(this)).finally(this.loadEntityMetadataCompleted.bind(this))},n.prototype.loadEntityMetadataCompleted=function(){this.vm.isBusy=!1},n.prototype.search=function(){this.vm.currentPage=1;this.filterAttributes()},n.prototype.showAttributes=function(n){n=n||this.vm.entityAttributes;var t=this.vm.pageSize,i=(this.vm.currentPage-1)*t;this.vm.total=n.length;this.vm.attributes=n.filter(function(n,r){return r>=i&&r<i+t})},n.$inject=["$scope","metadataBrowser.core.dataService"],n}();angular.module(n.Config.moduleName).directive("tsEntityDetails",t)})(t=n.Controller||(n.Controller={}))}(MetadataBrower||(MetadataBrower={})),function(n){var t;(function(){"use strict";function t(){return{restrict:"A",scope:{object:"="},templateUrl:"templates/property_browser.html"}}angular.module(n.Config.moduleName).directive("tsPropertyBrowser",t)})(t=n.Controllers||(n.Controllers={}))}(MetadataBrower||(MetadataBrower={}));